<!DOCTYPE html>
<html>
<head>
<meta http-equiv="X-UA-Compatible" content="IE=Edge">
<link href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.css" rel="stylesheet" type="text/css"/>
<link href="css/leaflet.label.css" rel="stylesheet" type="text/css"/>

<style>
body {
    margin: 0;
    padding: 0;
}
#map {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 100%;
}
</style>
</head>
<body>
    <div id="map"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.4.9/d3.min.js"></script>
<script src="js/leaflet-providers.js"></script>
<script src="js/leaflet.polylinedecorator.min.js"></script>
<script src="js/leaflet.label.js"></script>
<script>
/* Begin Config */
var startLatLng = [3.175, 73.509];
var startZoom = 7;
/* End Config */

var atollLayers = {};
var linkLayers = {};
var atollSelected = null;

// Create map and center around Maldives
var watercolor = L.tileLayer('http://c.tile.stamen.com/watercolor/{z}/{x}/{y}.jpg', { 
        attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors' 
    });
var esriMap = L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/Ocean/World_Ocean_Base/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
var satellite = L.tileLayer('http://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
    });
var mapzen = L.tileLayer('https://vector.mapzen.com/osm/all/{z}/{x}/{y}.json?api_key=vector-tiles-Na4Mgza', {
  attribution: '<a href="https://www.mapzen.com/rights">Attribution.</a>. Data &copy;<a href="https://openstreetmap.org/copyright">OSM</a> contributors.'
});
var mapzen = L.tileLayer('https://vector.mapzen.com/osm/earth/{z}/{x}/{y}.json?api_key=vector-tiles-Na4Mgza', {
  attribution: '<a href="https://www.mapzen.com/rights">Attribution.</a>. Data &copy;<a href="https://openstreetmap.org/copyright">OSM</a> contributors.'
});
http://{s}.basemaps.cartocdn.com/{basemap-name}/{z}/{x}/{y}@2x.png

var map = L.map('map', {
    center: startLatLng,
    zoom: startZoom,
    layers: [ 
        esriMap
    ]
});

L.control.layers({ 'Satellite': satellite, 'Terrain': esriMap, 'Watercolor': watercolor, 'mapzen': mapzen}).addTo(map);

// Load the atolls GeoJSON file
d3.json('http://unfpamaldives.github.io/atolls.geoJson', function(error, atolls) {
    if (error) throw error;

    var atollLayer = L.geoJson(atolls, {
        onEachFeature: function (feature, layer) {

            var atollStyle = {
                'opacity': 0.1,
                'color': null
            };

            var immigrants = 0,
                emigrants = 0;

            layer
                .setStyle(atollStyle)
                .bindLabel(feature.properties.name, { noHide: true })
                .on('mouseover', function () {
                    this.setStyle({
                        'opacity': 0.9,
                        'color': 'white'
                    });                    
                })
                .on('mouseout', function () {
                    this.setStyle(atollStyle);
                })
                .on('dblclick', function () {

                    layer.bindPopup('<h5>' + feature.properties.name + '</h5><p>Immigration: ' + immigrants + '</p><p>Emigration: ' + emigrants + '</p>').openPopup();
                })
                .on('click', function (e) {

                    layer.closePopup();
                    







                    for (var linkPath in linkLayers) {
                        var path = linkPath.split('-');

                        if (atollSelected != null && atollSelected != path[0]) {
                            map.addLayer(linkLayers[linkPath].feature);
                        }
                    }

                    if (atollSelected == null || atollSelected != feature.id) {

                        for (var linkPath in linkLayers) {
                            var path = linkPath.split('-');

                            if (feature.id != path[0] && feature.id != path[1]) {
                                map.removeLayer(linkLayers[linkPath].feature);
                            }
                            else {
                                if (feature.id == path[0]) emigrants += parseInt(linkLayers[linkPath].data.value);
                                if (feature.id == path[1]) immigrants += parseInt(linkLayers[linkPath].data.value);
                            }
                        }






                        atollSelected = feature.id;
                    }
                    else {
                        
                        atollSelected = null;
                    }
                    
                });

            atollLayers[feature.id] = {
                layer: layer,
                center: layer.getBounds().getCenter()
            };
        }, 
        style: function (feature) {
            return {
                stroke: 'black',
                weight: 1,
                opacity: 0.1
            }
        }
    }).addTo(map);

    d3.json('http://codepen.io/laissezpasser/pen/RaeKLQ.js', function(error, links) {
        if (error) throw error;







        var weightMin = d3.min(links, function(l) { return l.value }),
            weightMax = d3.max(links, function(l) { return l.value });

        var weightScale = d3.scale.linear()
                    .domain([weightMin, weightMax])
                    .range([0, 300]);

        links.forEach(function (link) {
            if (link.source != link.target) {

                var path = [ link.source, link.target ].join('-');
                var pathReverse = [ link.target, link.source ].join('-')

                var linkStyle = {
                    color: (linkLayers[pathReverse]) ? 'violet' : 'orange',
                    weight: weightScale(link.value),
                    smoothFactor: 1,
                    opacity: .5,
                    fill: false,
                    class: path
                };


                var linkCenter = L.polyline([ atollLayers[link.source].center, atollLayers[link.target].center ]).getBounds().getCenter();
                if (linkStyle.color == 'violet') {
                    var lineCenter = L.latLng(
                        (linkCenter.lat * .001) + linkCenter.lat, 
                        (linkCenter.lng * .001) + linkCenter.lng
                    );
                }
                else {
                    var lineCenter = L.latLng(
                        linkCenter.lat - (linkCenter.lat * .001), 
                        linkCenter.lng - (linkCenter.lng * .001)
                    );
                }
                



                var line = L.polyline([ atollLayers[link.source].center, lineCenter, atollLayers[link.target].center ], linkStyle);
                var arrow = L.polylineDecorator(line, { patterns: [{
                        offset: '55%', 
                        symbol: L.Symbol.arrowHead({
                            polygon: false, 
                            pathOptions: {
                                weight: weightScale(link.value * .4),
                                color: linkStyle.color,
                                fill: true,
                            }
                        })
                    }]});





                var feature = L.featureGroup([line, arrow])
                    .bindPopup('<h5>' + link.source + ' to ' + link.target + '</h5>' + link.value + ' migrants')
                    .on('mouseover', function(e) {
                        this.setStyle({
                            opacity: 1
                        });
                    })
                    .on('mouseout', function(e) {
                        this.setStyle(linkStyle);
                    })
                    .addTo(map);

                linkLayers[path] = {
                    feature: feature,
                    line: line,
                    arrow: arrow,
                    data: link
                }   
            }
        });

    });
});




</script>
</body>
</html>




